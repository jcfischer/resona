---
feature: "LanceDB Write Batching"
spec: "./spec.md"
status: "draft"
---

# Technical Plan: LanceDB Write Batching

## Architecture Overview

Buffer embedding records in memory before writing to LanceDB in larger batches. This is a localized optimization within the existing `embedBatch()` flow.

```
Current Flow:
┌─────────┐    ┌─────────┐    ┌─────────┐
│ Ollama  │───▶│ Build   │───▶│ LanceDB │  ◀── Write every batch (~50 records)
│ embed() │    │ Records │    │ store() │
└─────────┘    └─────────┘    └─────────┘
     ▲              │
     └──────────────┘
     Loop: batchSize (provider.maxBatchSize)

New Flow:
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ Ollama  │───▶│ Build   │───▶│ Buffer  │───▶│ LanceDB │
│ embed() │    │ Records │    │ (5000)  │    │ store() │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
     ▲              │              │
     └──────────────┘              │
     Loop: batchSize          Flush when full
```

## Technology Stack

| Component | Choice | Rationale |
|-----------|--------|-----------|
| Language | TypeScript | Existing codebase |
| Runtime | Bun | Existing codebase |
| Storage | LanceDB | Existing - optimizing write pattern |
| Buffer | Array | Simple in-memory buffer, no extra deps |

## Constitutional Compliance

- [x] **CLI-First:** N/A - library change, CLI consumers unchanged
- [x] **Library-First:** Core logic in EmbeddingService, reusable by all consumers
- [x] **Test-First:** New tests for buffer logic, verify existing tests unchanged
- [x] **Deterministic:** Same embeddings, same results - only write timing changes
- [x] **Code Before Prompts:** Pure code change, no prompts involved

## Data Model

### Type Updates (src/types.ts)

```typescript
// BatchEmbedOptions - ADD storeBatchSize
export interface BatchEmbedOptions {
  onProgress?: (progress: BatchEmbedProgress) => void;
  progressInterval?: number;
  commitInterval?: number;  // Existing but unused - remove?
  forceAll?: boolean;

  // NEW: LanceDB write batching
  /** Batch size for LanceDB writes (default: 5000) */
  storeBatchSize?: number;
}

// BatchEmbedProgress - ADD stored and bufferSize
export interface BatchEmbedProgress {
  processed: number;    // Embeddings generated by provider
  skipped: number;      // Unchanged items
  errors: number;       // Failed items
  total: number;        // Total to process
  currentItem?: string;
  rate?: number;

  // NEW: Storage progress
  /** Embeddings written to LanceDB */
  stored: number;
  /** Current buffer occupancy */
  bufferSize: number;
}
```

### No Database Schema Changes

LanceDB schema remains unchanged - only write pattern changes.

## API Contracts

### Modified: embedBatch()

```typescript
/**
 * Embed multiple items with progress tracking
 *
 * @param items - Items to embed
 * @param options - Batch options including new storeBatchSize
 * @returns Batch result statistics
 */
async embedBatch(
  items: ItemToEmbed[],
  options: BatchEmbedOptions = {}
): Promise<BatchEmbedResult>
```

**New option behavior:**
- `storeBatchSize` (default: 5000): Buffer this many records before LanceDB write
- Progress callback receives `stored` and `bufferSize` fields

**Backward compatible:**
- Existing callers continue to work
- New progress fields are additive (won't break destructuring)

## Implementation Strategy

### Phase 1: Types (Foundation)

Update type definitions with new fields.

- [ ] Add `storeBatchSize` to `BatchEmbedOptions`
- [ ] Add `stored` and `bufferSize` to `BatchEmbedProgress`
- [ ] Update `BatchEmbedResult` if needed (may add `stored` for final count)

### Phase 2: Buffer Logic (Core)

Modify `embedBatch()` in `embedding-service.ts`:

```typescript
async embedBatch(items, options = {}) {
  const {
    storeBatchSize = 5000,  // NEW: default 5000
    onProgress,
    progressInterval = 100,
    forceAll = false
  } = options;

  // NEW: Buffer for batched writes
  const buffer: EmbeddingRecord[] = [];
  let stored = 0;

  // ... existing hash map logic ...

  for (let i = 0; i < itemsToEmbed.length; i += batchSize) {
    // Get embeddings from provider
    const embeddings = await this.provider.embed(texts);

    // Build records
    const records = /* ... existing logic ... */;

    // NEW: Add to buffer instead of immediate write
    buffer.push(...records);
    result.processed += records.length;

    // NEW: Flush when buffer full
    if (buffer.length >= storeBatchSize) {
      await this.storeEmbeddingsBatch(buffer);
      stored += buffer.length;
      buffer.length = 0;  // Clear buffer
    }

    // Progress with new fields
    if (onProgress && shouldReport) {
      onProgress({
        processed: result.processed,
        skipped: result.skipped,
        errors: result.errors,
        total: items.length,
        rate,
        stored,              // NEW
        bufferSize: buffer.length,  // NEW
      });
    }
  }

  // NEW: Flush remaining buffer
  if (buffer.length > 0) {
    await this.storeEmbeddingsBatch(buffer);
    stored += buffer.length;
  }

  return result;
}
```

### Phase 3: Tests (Validation)

- [ ] Test buffer fills to threshold before write
- [ ] Test partial buffer flush at end
- [ ] Test progress callback receives new fields
- [ ] Test backward compatibility (no storeBatchSize option)
- [ ] Verify existing tests still pass

## File Structure

```
src/
├── service/
│   └── embedding-service.ts  # [Modified] - Add buffer logic
└── types.ts                  # [Modified] - Add new type fields

tests/
└── embedding-service.test.ts # [Modified] - Add buffer tests
```

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Memory pressure with large buffer | Medium | Low | 5000 * 4KB = 20MB, acceptable |
| Incomplete write on crash | Medium | Low | Acceptable for embedding cache - can regenerate |
| Breaking existing consumers | High | Very Low | All changes additive, defaults preserve behavior |

## Dependencies

### External

- None - using existing LanceDB and provider dependencies

### Internal

- `storeEmbeddingsBatch()` - Already handles batch writes, just called less frequently

## Migration/Deployment

- [x] Database migrations needed? **No** - write pattern only
- [x] Environment variables? **No**
- [x] Breaking changes? **No** - fully backward compatible

## Estimated Complexity

- **New files:** 0
- **Modified files:** 2 (types.ts, embedding-service.ts)
- **Test additions:** ~4-6 new test cases
- **Estimated tasks:** ~6

## Performance Expectations

| Metric | Before | After |
|--------|--------|-------|
| LanceDB writes (100k items) | ~2000 | ~20 |
| Write reduction | - | 100x |
| Memory overhead | 0 | ~20-40MB |
| Total time | Baseline | ~10-20% faster |
